#BehaviorTree基本逻辑

## 1. 树叶关系

整棵树存在四片叶子，分别为  **数据读取树叶**  ，  **小陀螺控制树叶**    ，  **导航控制树叶**   ， **自瞄/扫描控制树叶**。

四片叶子均为  **异步独立节点**  ， 其中 **数据树叶**  持续运行 ，**树干**  以一定**帧率**对其信息进行综合处理，控制其他三片树叶的运行和停止。



##2.信息数据

目前行为树需要三种信息，分别为  **装甲板识别信息**  ，  **导航信息**   ，  **比赛状况信息**  

**装甲板识别信息**： 识别到的装甲板数量 ， 识别到的最近装甲板距离  ( 自瞄节点返回  )

**导航信息**： 目的位置（车间通讯云台返回） ，   目前自身位置（导航节点返回）

**比赛状况信息** ： 己方前哨站状态 ， 哨兵自身状态（剩余血量，剩余子弹数目），比赛剩余时间。 （ 裁判系统返回 ）

信息均由时间戳判断信息是否更新。

为了防止裁判系统出问题或者场上局面发生变化需要立即开启小陀螺，附加一个云台手对小陀螺的控制信息，此信息**优先级高于**裁判系统返回的前哨站状态信息。



## 3. 接口

**数据读取叶节点** ： 所有数据写入**黑板**，其他叶节点从黑板读数据。

**小陀螺叶节点** ： 从**黑板**读取  **前哨站状态** ，  向通讯节点发送 **是否开启小陀螺消息**

**导航叶节点** ： **从黑板**读取 **导航数据** ，向导航节点发送    **目的地位置**  以及   **是否中断导航**

**自瞄/扫描叶节点** ： **从黑板**读如 **识别数据** ， 向通讯节点发送  **扫描/自瞄模式**  ，  **射击频率**  （自瞄模式下只要收到大于0的射击频率信息，则会进行射击）



## 4. 单片树叶逻辑

每片叶子**独立运行** ， 若某片叶子运行失败则**至多重试三次** ， 若依然失败则会选择默认情况进行执行。其后树干每次运行该节点都会尝试正常状态，直至正常状态成功运行则暂停默认状态。

**树叶默认状态：**

 开启小陀螺    ，  返回巡逻区中心  ,   自瞄 



## 5. 树干逻辑

整个哨兵分为两种姿态  ：    **进攻姿态**  ，  **防御姿态**

姿态切换标准：

前哨站血量低于500，进入防御姿态；其余时刻为进攻姿态。

进攻姿态：不开启小陀螺   （进攻姿态前哨站未破，是无敌姿态）

1. 在导航目标位置未更新的情况下 ，只控制  **扫描自瞄树叶**  ，若识别到敌方装甲板根据比赛   **比赛剩余时间**   和  **剩余子弹数量** ,   **装甲板距离 ** 计算射击频率  ，判断如何击打。
2. 若目标位置更新 ， 但仍处于进攻姿态 ，开启并控制 **导航树叶**  和 **扫描自瞄树叶**  ，二者并行 ， 移动过程中若识别到装甲板 ， 根据    **比赛剩余时间**   和  **剩余子弹数量**  ,   **装甲板距离** 计算发弹频率，若发弹频率低于5，说明价值不大，将其改为0 ，专心导航； 若频率大于等于5 ，暂时阻断导航进程 ，利用自瞄进行击打，直至发弹频率更新为低于5的状态， 停止发弹 ， 继续导航进程。 

防御姿态：开启小陀螺

1. 在导航目标位置未更新的情况下，控制  **扫描自瞄树叶** ，无限制击打。
2. 若导航位置更新 ，保持   **扫描自瞄树叶**  ，若识别到敌方装甲板，进行无限制击打，但不会主动停止导航，同时进行导航。（此设计主要用于防止哨兵被敌方机器人卡位的情况）



## 6.判断是否发弹逻辑

~~哨兵枪口热量上限   ：  240~~

~~无增益情况下热量冷却：   80/s~~

~~一发弹丸增加热量： 10   8发/s~~

~~高地增益，前哨站增益：  五倍枪口热量冷却增益   ，  400/s  也就是至少能保持40发每秒~~

~~**判断1：**根据热量计算当前最多发弹量，允许发弹量在此限制之下~~



**判断**：结合多种情况计算发弹频率。  

x1 = 当前比赛剩余时间  , x2 = 当前剩余子弹数目 ， x3 = 识别到的最近的装甲板的距离 ，单位毫米

​    $n = 20 + \sqrt{x1} - 0.3*\sqrt{x2} - (x3/1000)^{3}$ 

补丁：如果装甲板距离小于1m，则无限制击打。



## 7.ps

1.若小陀螺因为外因无法旋转，行为树控制消息不会改变，如何重新启动小陀螺由电控实现。

2.被堵截且无法识别对方装甲板，怎么办？

3.为了防止误识别，自瞄节点在连续识别到几张图像后才会向行为树发送消息。

4.可以考虑加一些特殊树叶 ，均由云台手操控，享有最高优先级：

例如被对方堵截，可以以最大功率向右移动一米再向前移动一米进行摆脱，此后恢复正常逻辑状态。

###### 













*
